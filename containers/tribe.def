Bootstrap: docker
From: nvidia/cuda:12.4.1-runtime-ubuntu22.04

%labels
    Author Maximilien Leclei
    Description TRIBE feature extraction container (Python 3.12 + CUDA 12.4)

%post
    export DEBIAN_FRONTEND=noninteractive

    # Base packages + deadsnakes PPA for Python 3.12
    apt-get update && apt-get install -y --no-install-recommends \
        software-properties-common gpg-agent \
        ffmpeg git \
        && add-apt-repository -y ppa:deadsnakes/ppa \
        && apt-get update \
        && apt-get install -y --no-install-recommends \
            python3.12 python3.12-venv python3.12-dev \
        && rm -rf /var/lib/apt/lists/*

    # Make python3 point to 3.12
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

    # Bootstrap pip for 3.12
    python3 -m ensurepip --upgrade
    python3 -m pip install --no-cache-dir --upgrade pip

    # Install Python packages
    python3 -m pip install --no-cache-dir \
        torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 \
        numpy scipy pandas pyarrow packaging \
        transformers moviepy spacy nilearn Levenshtein julius h5py \
        decorator matplotlib platformdirs pygments pillow \
        "huggingface_hub[cli]" \
        exca

    # Download spacy model (baked into container)
    python3 -m spacy download en_core_web_lg

    # Create mount points
    mkdir -p /tribe /hf_cache /data /scratch_host

%environment
    # Python finds source code via PYTHONPATH (no editable installs needed)
    export PYTHONPATH=/tribe/data_utils:/tribe/modeling_utils:/tribe
    export HF_HOME=/hf_cache
    export HF_HUB_OFFLINE=1
    export TRANSFORMERS_OFFLINE=1
    export PYTHONUNBUFFERED=1

%runscript
    exec python3 "$@"
